#include <HardwareSerial.h>
#include <DFRobotDFPlayerMini.h>

// ---------- Pin-definities ----------
#define RELAY1 13
#define RELAY2 12
#define RELAY3 14
#define RELAY4 27
#define DF_BUSY 26  // DFPlayer BUSY-pin (LOW = playing)

const int buttonPins[6] = {5, 22, 23, 18, 19, 21};  // 5 levels + 1 stopknop

// ---------- Level-configuratie ----------
struct LevelConfig {
  int tracks[6];         // tracks per level
  int trackCount;        // aantal tracks
  int relays[4];         // 0 = uit, 1 = flits actief
  int flashMin;          // minimale flits interval (ms)
  int flashMax;          // maximale flits interval (ms)
  int volume;            // DFPlayer volume 0-30
  int uitlegTrack;       // track voor uitleg bij eerste klik
};

LevelConfig levels[5] = {
  {{7,8,9,10,11,12}, 6, {0,0,0,0}, 500, 2000, 10, 2},  // Level 1
  {{13,14,15,16}, 4, {1,0,0,0}, 100, 500, 15, 3},   // Level 2
  {{17,18,19,20,21,22}, 6, {1,1,1,0}, 50, 200, 20, 4},    // Level 3
  {{23,24,25,26}, 4, {1,1,1,1}, 50, 75, 22, 5}, // Level 4
  {{26,27,28,29,30}, 5, {1,1,0,1}, 100, 300, 25, 6} // Level 5
};

// ---------- Globale variabelen ----------
HardwareSerial mySerial(2);  // UART2
DFRobotDFPlayerMini myDFPlayer;

int currentLevel = -1;
int pendingLevel = -1;
bool relaysOn = false;
unsigned long lastFlash = 0;
unsigned long flashDelay = 0;
bool isPlaying = false;
unsigned long lastCheck = 0;
int lastTrackPlayed = -1;

// ---------- Functies ----------
void setAllRelays(bool state) {
  digitalWrite(RELAY1, state);
  digitalWrite(RELAY2, state);
  digitalWrite(RELAY3, state);
  digitalWrite(RELAY4, state);
}

void stopAll() {
  Serial.println("ðŸ›‘ Alles gestopt");
  setAllRelays(HIGH);
  myDFPlayer.stop();
  currentLevel = -1;
  pendingLevel = -1;
  isPlaying = false;
}

void playRandomTrack(int level) {
  int count = levels[level-1].trackCount;
  int randomIndex;
  do {
    randomIndex = random(0, count);
  } while (levels[level-1].tracks[randomIndex] == lastTrackPlayed);

  int track = levels[level-1].tracks[randomIndex];
  lastTrackPlayed = track;

  Serial.print("â–¶ï¸ Level ");
  Serial.print(level);
  Serial.print(" â€” speelt random track ");
  Serial.println(track);
  myDFPlayer.play(track);
  isPlaying = true;
}

void flashRelaysLevel(int level) {
  unsigned long now = millis();
  if (now - lastFlash > flashDelay) {
    relaysOn = !relaysOn;

    for (int i = 0; i < 4; i++) {
      if (levels[level-1].relays[i] == 1) {
        digitalWrite((i==0?RELAY1:(i==1?RELAY2:(i==2?RELAY3:RELAY4))),
                     relaysOn ? LOW : HIGH);
      } else {
        digitalWrite((i==0?RELAY1:(i==1?RELAY2:(i==2?RELAY3:RELAY4))), HIGH);
      }
    }

    flashDelay = relaysOn ? random(levels[level-1].flashMin, levels[level-1].flashMax)
                          : random(levels[level-1].flashMin, levels[level-1].flashMax*4);
    lastFlash = now;
  }
}

// ---------- Setup ----------
void setup() {
  Serial.begin(115200);
  Serial.println("ðŸŽ¬ ESP32 start...");

  // Relais setup
  pinMode(RELAY1, OUTPUT);
  pinMode(RELAY2, OUTPUT);
  pinMode(RELAY3, OUTPUT);
  pinMode(RELAY4, OUTPUT);
  setAllRelays(HIGH);

  // DFPlayer BUSY-pin
  pinMode(DF_BUSY, INPUT);

  // Knoppen
  for (int i = 0; i < 6; i++) {
    pinMode(buttonPins[i], INPUT_PULLUP);
  }

  // DFPlayer op UART2
  mySerial.begin(9600, SERIAL_8N1, 16, 17);
  if (!myDFPlayer.begin(mySerial)) {
    Serial.println("âŒ DFPlayer niet gevonden!");
    while (true);
  }

  Serial.println("âœ… DFPlayer verbonden");
  myDFPlayer.volume(18);
  randomSeed(analogRead(34));

  // ðŸ”Š SPEEL AUDIO 1 bij opstart
  Serial.println("ðŸŽµ Start audio 1 bij opstart...");
  myDFPlayer.play(1);
  while (digitalRead(DF_BUSY) == LOW) delay(100);
  Serial.println("âœ… Audio 1 is klaar â€” setup compleet!");
}

// ---------- Loop ----------
void loop() {
  // Knop uitlezen
  for (int i = 0; i < 6; i++) {
    if (digitalRead(buttonPins[i]) == LOW) {
      delay(200);  // debounce

      if (i == 5) {  // Stopknop
        stopAll();
        continue;
      }

      int selectedLevel = i + 1;

      // Eerste klik â†’ speel uitleg
      if (pendingLevel == -1 && currentLevel == -1) {
        pendingLevel = selectedLevel;
        Serial.print("ðŸ—£ Uitleg voor level ");
        Serial.println(pendingLevel);
        myDFPlayer.play(levels[pendingLevel-1].uitlegTrack);
        while (digitalRead(DF_BUSY) == LOW) delay(100);
        Serial.println("âœ… Uitleg klaar. Klik nogmaals om te starten!");
      }
      // Tweede klik â†’ start level
      else if (pendingLevel == selectedLevel && currentLevel == -1) {
        Serial.print("ðŸŒ© Start level ");
        Serial.println(selectedLevel);
        currentLevel = selectedLevel;
        pendingLevel = -1;
        myDFPlayer.volume(levels[currentLevel-1].volume);
        playRandomTrack(currentLevel);
      }
    }
  }

  // Flash gedrag tijdens spelen
  if (currentLevel != -1) {
    flashRelaysLevel(currentLevel);
  }

  // Check elke halve seconde of de track klaar is
  if (currentLevel != -1 && millis() - lastCheck > 500) {
    lastCheck = millis();
    if (isPlaying && digitalRead(DF_BUSY) == HIGH) {
      Serial.println("âœ… Track afgelopen â€” volgende random track start...");
      delay(1000);
      playRandomTrack(currentLevel);
    }
  }
}
