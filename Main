#include <HardwareSerial.h>
#include <DFRobotDFPlayerMini.h>

// ---------- Pin-definities ----------
#define RELAY1 13
#define RELAY2 12
#define RELAY3 14
#define RELAY4 27

const int buttonPins[6] = {5, 22, 23, 18, 19, 21};  // 5 levels + 1 stopknop

// ---------- Tracks en relais per level ----------
const int tracksPerLevel[5][3] = {
  {1, 2, 3},      // Level 1
  {4, 5, 6},      // Level 2
  {7, 8, 9},      // Level 3
  {10, 11, 12},   // Level 4
  {13, 14, 15}    // Level 5
};
const int tracksPerLevelCount[5] = {3, 3, 3, 3, 3};

const int relaysPerLevel[5][4] = {
  {0, 0, 0, 0},  // Level 1
  {1, 0, 0, 0},  // Level 2
  {1, 1, 1, 0},  // Level 3
  {1, 1, 1, 1},  // Level 4
  {1, 1, 0, 1}   // Level 5
};

// ---------- Globale variabelen ----------
HardwareSerial mySerial(2);  // âœ… UART2
DFRobotDFPlayerMini myDFPlayer;

int currentLevel = -1;
unsigned long lastFlash = 0;
unsigned long flashDelay = 0;
bool relaysOn = false;

// ---------- Functies ----------
void setAllRelays(bool state) {
  digitalWrite(RELAY1, state);
  digitalWrite(RELAY2, state);
  digitalWrite(RELAY3, state);
  digitalWrite(RELAY4, state);
}

void playRandomTrackForLevel(int level) {
  int trackCount = tracksPerLevelCount[level - 1];
  int randomIndex = random(0, trackCount);
  int track = tracksPerLevel[level - 1][randomIndex];
  Serial.print("â–¶ï¸ Level ");
  Serial.print(level);
  Serial.print(" â€” speelt track ");
  Serial.println(track);
  myDFPlayer.play(track);
}

void flashRelaysLevel(int level) {
  unsigned long now = millis();
  if (now - lastFlash > flashDelay) {
    relaysOn = !relaysOn;

    for (int i = 0; i < 4; i++) {
      if (relaysPerLevel[level - 1][i] == 1) {
        digitalWrite((i == 0 ? RELAY1 :
                     (i == 1 ? RELAY2 :
                     (i == 2 ? RELAY3 : RELAY4))),
                     relaysOn ? LOW : HIGH);
      } else {
        digitalWrite((i == 0 ? RELAY1 :
                     (i == 1 ? RELAY2 :
                     (i == 2 ? RELAY3 : RELAY4))), HIGH);
      }
    }

    flashDelay = relaysOn ? random(50, 150) : random(500, 2000);
    lastFlash = now;
  }
}

void stopAll() {
  Serial.println("ðŸ›‘ Alles gestopt");
  setAllRelays(HIGH);
  myDFPlayer.stop();
  currentLevel = -1;
}

// ---------- Setup ----------
void setup() {
  Serial.begin(115200);
  Serial.println("ðŸŽ¬ ESP32 start...");

  // Relais setup
  pinMode(RELAY1, OUTPUT);
  pinMode(RELAY2, OUTPUT);
  pinMode(RELAY3, OUTPUT);
  pinMode(RELAY4, OUTPUT);
  setAllRelays(HIGH);

  // Knoppen
  for (int i = 0; i < 6; i++) {
    pinMode(buttonPins[i], INPUT_PULLUP);
  }

  // âœ… DFPlayer op UART2
  mySerial.begin(9600, SERIAL_8N1, 16, 17);
  if (!myDFPlayer.begin(mySerial)) {
    Serial.println("âŒ DFPlayer niet gevonden!");
    while (true);
  }
  myDFPlayer.volume(20);
  randomSeed(analogRead(34));
  Serial.println("âœ… DFPlayer verbonden");

  // Startgeluid
  Serial.println("â–¶ï¸ Startgeluid speelt af...");
  myDFPlayer.play(1);
  delay(4000);
  myDFPlayer.stop();

  Serial.println("âœ… Startup voltooid â€” wacht op knop...");
}

// ---------- Loop ----------
void loop() {
  for (int i = 0; i < 6; i++) {
    if (digitalRead(buttonPins[i]) == LOW) {
      delay(200);
      if (i == 5) {
        stopAll();
      } else {
        currentLevel = i + 1;
        Serial.print("ðŸŒ© Level geselecteerd: ");
        Serial.println(currentLevel);
        playRandomTrackForLevel(currentLevel);
      }
    }
  }

  if (currentLevel != -1) {
    flashRelaysLevel(currentLevel);
  }
}
