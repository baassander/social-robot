/*******************************************************************
* File Name         : Social Robot Thunderstorm fobia
* Date              : 14-12-2025
* Author            : Sander Blokland
/*******************************************************************/

#include <HardwareSerial.h>
#include <DFRobotDFPlayerMini.h>

// Blauwe uitleg-LEDs
const int blueLeds[4] = {25, 33, 32, 15};

// ---------- Pin-definities ----------
#define RELAY1 13
#define RELAY2 12
#define RELAY3 14
#define RELAY4 27
#define DF_BUSY 26  // DFPlayer BUSY-pin (LOW = playing)

const int buttonPins[6] = {5, 22, 23, 18, 19, 21};  // 5 levels + 1 stopknop

// ---------- Level-configuratie ----------
struct LevelConfig {
  int tracks[6];         // tracks per level
  int trackCount;        // aantal tracks
  int relays[4];         // 0 = uit, 1 = actief (flitsen bij start)
  int flashTime;         // hoe lang relais aan blijven (ms)
  int volume;            // DFPlayer volume 0-30
  int uitlegTrack;       // track voor uitleg bij eerste klik
};

LevelConfig levels[5] = {
  {{7,8,9,10,11,12},    6, {0,0,0,0}, 200, 5, 2},           // Level 1
  {{13,14,15,16},       4, {1,0,0,0}, 200, 10, 3},          // Level 2
  {{17,18,19,20,21,22}, 6, {1,0,0,1}, 200, 14, 4},          // Level 3
  {{23,24,25,26},       4, {1,1,1,1}, 200, 18, 5},          // Level 4
  {{26,27,28,29,30},    5, {1,1,1,1}, 200, 22, 6}           // Level 5
};

// ---------- Pauze-tracks ----------
const int pauseTracks[27] = {31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57};
const int pauseTrackCount = 27;
int pauseTrackVolume = 10; // volume voor pauze tracks
int pauseDelay = 10000;    // 10 seconden wachten na pauze

// ---------- Globale variabelen ----------
HardwareSerial mySerial(2);  // UART2
DFRobotDFPlayerMini myDFPlayer;

int currentLevel = -1;
int pendingLevel = -1;
int lastTrackPlayed = -1;

// ---------- Functies ----------
void setAllRelays(bool state) {
  digitalWrite(RELAY1, state);
  digitalWrite(RELAY2, state);
  digitalWrite(RELAY3, state);
  digitalWrite(RELAY4, state);
}

void setBlueLeds(bool state) {
  for (int i = 0; i < 4; i++) {
    digitalWrite(blueLeds[i], state ? HIGH : LOW);
  }
}

// Relais pulse één keer vóór elke track
void pulseRelays(int level) {
  Serial.println("⚡️ Relais tegelijk aan en uit vóór de track...");
  for (int i = 0; i < 4; i++) {
    if (levels[level-1].relays[i] == 1) {
      int pin = (i==0?RELAY1:(i==1?RELAY2:(i==2?RELAY3:RELAY4)));
      digitalWrite(pin, LOW); // AAN
    }
  }
  delay(levels[level-1].flashTime);
  setAllRelays(HIGH);
}

// Stop alle activiteiten
void stopAll() {
  setAllRelays(HIGH);
  myDFPlayer.stop();
  currentLevel = -1;
  pendingLevel = -1;
}

// Wacht tot audio klaar is
void waitUntilAudioFinished() {
  delay(300);
  while (digitalRead(DF_BUSY) == LOW) {
    delay(100);
  }
}

// Speel alle tracks van een level achter elkaar in random volgorde
void playLevelContinuous(int level) {
  while (currentLevel == level) {
    int count = levels[level-1].trackCount;
    int randomIndex;
    do {
      randomIndex = random(0, count);
    } while (levels[level-1].tracks[randomIndex] == lastTrackPlayed);

    int track = levels[level-1].tracks[randomIndex];
    lastTrackPlayed = track;

    // Pulse relais
    for (int i = 0; i < 4; i++) {
      int pin = (i==0?RELAY1:(i==1?RELAY2:(i==2?RELAY3:RELAY4)));
      digitalWrite(pin, (levels[level-1].relays[i] == 1) ? LOW : HIGH);
    }
    delay(levels[level-1].flashTime);
    setAllRelays(HIGH);

    // Speel track
    myDFPlayer.play(track);
    delay(200);

    // Wacht tot track klaar of stopknop gedrukt
    while (digitalRead(DF_BUSY) == LOW) {
      delay(50);
      if (digitalRead(buttonPins[5]) == LOW) { // Stopknop
        stopAll();
        return;
      }

      // Pauzeknop: 1-5 levelknoppen
      for (int i = 0; i < 5; i++) {
        if (digitalRead(buttonPins[i]) == LOW) {
          delay(200); // debounce
          Serial.println("⏸ Pauze!");
          setBlueLeds(true);

          // Speel random pauze-track met eigen volume
          int pauseTrack = pauseTracks[random(0, pauseTrackCount)];
          Serial.print("▶️ Pauze track: ");
          Serial.println(pauseTrack);
          myDFPlayer.volume(pauseTrackVolume);
          myDFPlayer.play(pauseTrack);
          waitUntilAudioFinished();

          setBlueLeds(false);
          Serial.println("▶️ Wacht 10 seconden voor hervatten...");
          delay(pauseDelay);

          // Hervat level volume
          myDFPlayer.volume(levels[currentLevel-1].volume);
        }
      }
    }
    delay(100); // buffer voor volgende track
  }
}

// ---------- Setup ----------
void setup() {
  Serial.begin(115200);

  // Relais setup
  pinMode(RELAY1, OUTPUT);
  pinMode(RELAY2, OUTPUT);
  pinMode(RELAY3, OUTPUT);
  pinMode(RELAY4, OUTPUT);
  setAllRelays(HIGH);

  // Blauwe LEDs setup
  for (int i = 0; i < 4; i++) {
    pinMode(blueLeds[i], OUTPUT);
    digitalWrite(blueLeds[i], LOW);
  }

  // DFPlayer BUSY-pin
  pinMode(DF_BUSY, INPUT);

  // Knoppen
  for (int i = 0; i < 6; i++) {
    pinMode(buttonPins[i], INPUT_PULLUP);
  }

  // DFPlayer op UART2
  mySerial.begin(9600, SERIAL_8N1, 16, 17);
  if (!myDFPlayer.begin(mySerial)) {
    Serial.println("DFPlayer niet gevonden!");
    while (true);
  }

  Serial.println("✅ DFPlayer verbonden");
  myDFPlayer.volume(12);
  randomSeed(analogRead(34));

  // Start audio bij opstart met blauwe LEDs
  setBlueLeds(true);
  myDFPlayer.play(1);
  waitUntilAudioFinished();
  setBlueLeds(false);
}

// ---------- Loop ----------
void loop() {
  for (int i = 0; i < 6; i++) {
    if (digitalRead(buttonPins[i]) == LOW) {
      delay(200); // debounce

      if (i == 5) { // Stopknop
        stopAll();
        continue;
      }

      int selectedLevel = i + 1;

      // Eerste klik → uitleg
      if (pendingLevel == -1 && currentLevel == -1) {
        pendingLevel = selectedLevel;
        setBlueLeds(true);
        myDFPlayer.play(levels[pendingLevel-1].uitlegTrack);
        waitUntilAudioFinished();
        setBlueLeds(false);
      }
      // Tweede klik → start level
      else if (pendingLevel == selectedLevel && currentLevel == -1) {
        currentLevel = selectedLevel;
        pendingLevel = -1;
        myDFPlayer.volume(levels[currentLevel-1].volume);
        playLevelContinuous(currentLevel);
      }
    }
  }
}
